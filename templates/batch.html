{% extends "base.html" %}
{% block main %}
<h1>Batch #{{ batch.id }} by {{ render_batch_user(batch) }}</h1>
{% set background_run = batch.background_runs.get_last() %}
{% set currently_running = background_run and not background_run[1] %}
<p class="lead">
  Targeting <a href="https://{{ batch.domain }}/">{{ batch.domain }}</a>.
  Created {{ batch.created | render_datetime }},
  last updated {{ batch.last_updated | render_datetime }}.
</p>
{% if background_run %}
<form method="post">
  <p>
    {% if currently_running %}
    Running in background since {{ background_run[0][0] | render_datetime }}
    {% else %}
    Ran in background from {{ background_run[0][0] | render_datetime }} to {{ background_run[1][0] | render_datetime }}
    {% endif %}
    (<a href="{{ url_for('batch_background_history', id=batch.id) }}">full history</a>).
    {% if currently_running and can_stop_background() %}
    <input name="csrf_token" type="hidden" value="{{ csrf_token() }}">
    <input name="offset" type="hidden" value="{{ offset }}">
    <input name="limit" type="hidden" value="{{ limit }}">
    <button class="btn btn-danger btn-sm" formaction="{{ url_for('stop_batch_background', id=batch.id) }}">Stop</button>
    {% endif %}
  </p>
</form>
{% endif %}
<nav aria-label="command pages">
  <ul class="pagination">
    {% if offset > 0 %}
    <li class="page-item"><a class="page-link" href="{{ url_for('batch', id=batch.id, offset=([0, offset-limit] | max), limit=limit) }}">Previous</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Previous</a></li>
    {% endif %}
    {% if offset + limit < (batch.command_records | length) %}
    <li class="page-item"><a class="page-link" href="{{ url_for('batch', id=batch.id, offset=offset+limit, limit=limit) }}">Next</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Next</a></li>
    {% endif %}
  </ul>
</nav>
{% set command_records = batch.command_records.get_slice(offset, limit) %}
{% for command_record in command_records %}
<div>
  {{ render_command_record(command_record, batch.domain) }}
</div>
{% endfor %}
{% if can_run_commands(command_records) %}
<form method="post" action="{{ url_for('run_batch_slice', id=batch.id) }}">
  <input name="csrf_token" type="hidden" value="{{ csrf_token() }}">
  <input name="offset" type="hidden" value="{{ offset }}">
  <input name="limit" type="hidden" value="{{ limit }}">
  <button class="btn btn-primary">Run these commands</button>
  {% if can_start_background() %}
  <button class="btn btn-secondary" formaction="{{ url_for('start_batch_background', id=batch.id) }}">Run whole batch in background</button>
  {% endif %}
</form>
{% endif %}
{% endblock %}
